<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <!-- 뷰포트 설정: 모바일 화면에서 기기 폭에 맞춰 보이도록 함 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>상대강도(RS) 기반 강세 종목 분석 리포트</title>
  <style>
    /* 전체 영역 스타일 */
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 20px;
      /* 큰 화면에서는 최대 1100px까지, 작은 화면에서는 100% 가깝게 */
      max-width: 1100px;
    }

    /* 제목 스타일 */
    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* 상단 컨테이너(업데이트 시간 + 검색창) */
    .top-container {
      display: flex;
      justify-content: space-between; /* 좌우로 배치 */
      align-items: center;
      margin-bottom: 10px;
      gap: 10px; /* 요소 사이 간격 */
      flex-wrap: wrap; /* 화면이 좁을 때 줄바꿈 */
    }

    .update-time {
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }

    /* 검색창 컨테이너 */
    .search-container {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* 검색창 및 버튼 */
    input {
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 5px;
      width: 200px;
    }

    button {
      padding: 10px 15px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }

    /* 테이블을 감싸는 래퍼: 화면이 작을 때 가로 스크롤 가능하게 */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;  /* 가로 스크롤 허용 */
      margin-top: 10px;
    }

    /* 테이블 스타일 */
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* 화면이 작아도 테이블이 너무 작아지지 않도록 최소 폭 설정 */
    }

    th, td {
      border: 1px solid #ccc;
      padding: 12px 8px;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    /* 페이지네이션 버튼 스타일 */
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: white;
      color: black;
      transition: 0.3s;
      min-width: 40px; 
    }
    .pagination button:hover {
      background-color: #007bff;
      color: white;
    }
    .pagination button:disabled {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      cursor: default;
    }

    /* 화면이 좁아졌을 때(가로폭 768px 이하)에 대한 반응형 스타일 */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 22px;
        margin-bottom: 15px;
      }

      .top-container {
        flex-direction: column; 
        align-items: flex-start;
      }

      .search-container {
        width: 100%;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      /* 검색창 폭 줄이기 */
      input {
        width: 100%;
        font-size: 14px;
      }

      /* 버튼 크기 약간 축소 */
      button {
        padding: 8px 12px;
        font-size: 14px;
      }

      /* 테이블 글자 크기와 패딩 줄이기 */
      th, td {
        padding: 8px 4px;
        font-size: 14px;
      }

      .pagination button {
        padding: 8px 12px;
        font-size: 12px;
      }

      /* 테이블 최소 폭도 조금 줄임 */
      table {
        min-width: 600px;
      }
    }
  </style>
</head>
<body>
  <!-- 제목 -->
  <h1>📌 상대강도(RS) 기반 강세 종목 분석 리포트</h1>

  <div class="top-container">
    <div id="updateTime" class="update-time"></div>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="🔍 종목명을 입력하세요...">
      <button onclick="filterTable()">검색</button>
    </div>
  </div>

  <!-- 테이블을 감싸는 래퍼로 가로 스크롤 허용 -->
  <div class="table-wrapper">
    <table id="stockTable">
      <thead>
        <tr>
          <th>종목코드</th>
          <th>이름</th>
          <th>종가</th>
          <th>상대강도</th>
          <th>최저가 대비 상승률</th>
          <th>최고가 대비 하락률</th>
          <th>섹터</th>
          <th>섹터 수익률 순위</th>
          <th>시가총액</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 페이지네이션 버튼 -->
  <div class="pagination" id="pagination"></div>

  <script>
    let allStocks = []; 
    let currentPage = 1;
    let totalPages = 1;
    const limit = 100;
    let filteredStocks = [];
    const API_URL = "https://backend-for-rs-production.up.railway.app/api/stocks"; 

    async function fetchAllStocks() {
      try {
        // 초기 로딩시 전체 데이터(최대 10,000개)를 가져와서 필터 / 페이지네이션 활용
        // ※ 실제 서비스에서는 서버 페이징을 적극 권장
        const response = await fetch(`${API_URL}?page=1&limit=10000`);
        const data = await response.json();
        allStocks = data.stocks;
        totalPages = Math.ceil(allStocks.length / limit);
        filteredStocks = [...allStocks];

        updateTable(getCurrentPageData());
        updatePagination();
        getUpdateTime();
      } catch (error) {
        console.error("❌ 데이터 로드 중 오류 발생:", error);
      }
    }

    function getUpdateTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();

      let updateDate;
      // 오후 3시 30분 이후라면 오늘 날짜, 그 전이면 어제 날짜로 표시
      if (hours > 15 || (hours === 15 && minutes >= 30)) {
        updateDate = now;
      } else {
        updateDate = new Date();
        updateDate.setDate(updateDate.getDate() - 1);
      }

      const year = updateDate.getFullYear();
      const month = String(updateDate.getMonth() + 1).padStart(2, "0");
      const day = String(updateDate.getDate()).padStart(2, "0");

      document.getElementById("updateTime").innerHTML =
        `📅 데이터 기준: ${year}.${month}.${day} 오후 3:30`;
    }

    function getCurrentPageData() {
      const startIdx = (currentPage - 1) * limit;
      return filteredStocks.slice(startIdx, startIdx + limit);
    }

    function updateTable(stocks) {
      const tbody = document.querySelector("#stockTable tbody");
      let html = "";

      stocks.forEach(stock => {
        let increaseRate = `<span style="color: red;">${stock["lowest_increase_rate"]}</span>`;
        let decreaseRate = `<span style="color: blue;">${stock["highest_decrease_rate"]}</span>`;

        html += `<tr>
          <td>
            <a href="https://finance.naver.com/item/main.naver?code=${stock.종목코드}"
               target="_blank">${stock.종목코드}</a>
          </td>
          <td>${stock.이름}</td>
          <td>${stock.종가}</td>
          <td>${Number(stock.relative_strength).toFixed(2)}</td>
          <td>${increaseRate}</td>
          <td>${decreaseRate}</td>
          <td>${stock.섹터}</td>
          <td>${stock["섹터 수익률 순위"]}</td>
          <td>${stock.시가총액}</td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }

    function updatePagination() {
      const paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = "";

      paginationDiv.innerHTML += `
        <button onclick="changePage(${currentPage - 1})"
          ${currentPage === 1 ? "disabled" : ""}>이전</button>`;

      for (let i = 1; i <= totalPages; i++) {
        paginationDiv.innerHTML += `
          <button onclick="changePage(${i})"
            ${i === currentPage ? "disabled" : ""}>${i}</button>`;
      }

      paginationDiv.innerHTML += `
        <button onclick="changePage(${currentPage + 1})"
          ${currentPage === totalPages ? "disabled" : ""}>다음</button>`;
    }

    function changePage(page) {
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTable(getCurrentPageData());
        updatePagination();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    function filterTable() {
      const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      filteredStocks = allStocks.filter(stock => 
        stock.이름.toLowerCase().includes(searchTerm)
      );
      totalPages = Math.ceil(filteredStocks.length / limit);
      currentPage = 1;
      updateTable(getCurrentPageData());
      updatePagination();
    }

    document.getElementById("searchInput")
            .addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        filterTable();
      }
    });

    // 페이지 로드시 데이터 불러오기
    fetchAllStocks();
  </script>
</body>
</html>
